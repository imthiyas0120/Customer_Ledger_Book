{% extends 'accounts/base.html' %}
{% block content %}

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />


<style>

    
    .ledger-header {
        text-align: center;
        margin-top: 10px;
        margin-bottom: 25px;
    }

    .ledger-header h2 {
        margin-bottom: 5px;
        font-size: 28px;
    }

    
    .totals-box {
        width: 350px;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 15px;
        background: #fafafa;
        margin-left: 20px;
        font-size: 18px;
        margin-bottom: 25px;
    }

    .totals-box th, 
    .totals-box td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }

    .totals-box tr:last-child td {
        font-weight: bold;
        border-bottom: none;
    }

    
    .btn-add {
        padding: 10px 25px;
        border-radius: 6px;
        background: #007bff;
        color: white;
        text-decoration: none;
        font-size: 16px;
        margin-right: 10px;
        display: inline-block;
    }
    .btn-add:hover { background: #0065d1; }

    .btn-action {
        padding: 6px 12px;
        border-radius: 6px;
        color: white;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-right: 4px;
    }

    .btn-download {
    padding: 9px 20px;
    border-radius: 6px;
    background: #28a745;
    color: white;
    font-size: 16px;
    text-decoration: none;
    display: inline-block;
    margin-left: 10px;
    transition: 0.2s;
    }

.btn-download:hover {
    background: #1e7d34;
    
    }


    .btn-view { background: #17a2b8; }
    .btn-view:hover { background: #0f7a8b; }

    .btn-edit { background: #28a745; }
    .btn-edit:hover { background: #1e7d34; }

    .btn-delete { background: #dc3545; }
    .btn-delete:hover { background: #b5212e; }

    
    .ledger-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        font-size: 17px;
    }

    .ledger-table th {
        background: #f1f1f1;
        padding: 10px;
        border: 1px solid #ccc;
        font-weight: bold;
    }

    .ledger-table td {
        padding: 10px;
        border: 1px solid #ccc;
    }

    .action-col { 
        white-space: nowrap;
        text-align: center;
    }

    
    .credit-box {
        width: 60%;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 20px 25px;
        margin: 20px 0;
        background: #fafafa;
    }

    .box-green {
        background-color: #d9ffe0 !important;   
        color: #0a7a1c !important;              
        font-weight: bold;
        text-align: center;
            }

    .box-red {
        background-color: #ffe0e0 !important;  
        color: #b30000 !important;             
        font-weight: bold;
        text-align: center;
        }


    @media (max-width: 768px) {

    /*  PAGE FIX  */
    html, body, .container {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden !important; /* page never scrolls */
    }

    /*  HEADER */
    .ledger-header h2 {
        font-size: 20px;
        text-align: center;
    }

    .ledger-header p {
        font-size: 14px;
        text-align: center;
        margin: 4px 0;
    }

    /* TOTALS  */
    .totals-box {
        width: calc(100% - 8px);
        margin: 10px auto 20px;
        font-size: 14px;
        padding: 12px;
    }

    .totals-box th,
    .totals-box td {
        padding: 6px;
    }

    /*  ADD / DOWNLOAD BUTTONS  */
    .btn-add,
    .btn-download {
        display: block;
        width: 90%;
        max-width: 320px;
        margin: 10px auto;
        text-align: center;
        font-size: 14px;
        padding: 10px 0;
        border-radius: 10px;
    }

    /*  TABLE SCROLL (KEY PART)*/
    .ledger-table-scroll {
        width: 100%;
        overflow-x: auto;                  /* ONLY table scrolls */
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x;
        margin-bottom: 20px;
    }

    /*  TABLE  */
    .ledger-table {
        min-width: 750px;        /* force horizontal scroll */
        width: max-content;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 11px;
        background: white;
    }

    .ledger-table th,
    .ledger-table td {
        padding: 6px 4px;
        text-align: center;
        white-space: normal;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    /* ACTIONS */
    .action-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .btn-action {
        width: 60px;
        font-size: 10px;
        padding: 4px 0;
        border-radius: 5px;
        text-align: center;
        white-space: nowrap;
    }

    h2, h3 {
        text-align: center;
        font-size: 18px;
        margin-top: 20px;
    }

    /* CREDIT BOX */
    .credit-box {
       
        margin: 15px auto;
        padding: 16px;
        border-radius: 14px;
        font-size: 14px;
        width: calc(100% - 6px);
    }

    .credit-box table {
        width: 100%;
        font-size: 14px;
        border-spacing: 0 10px;
    }

    .credit-box td {
        display: block;
        width: 100%;
    }

    .credit-box td:first-child {
        font-weight: bold;
        margin-bottom: 4px;
    }

    /* Inputs & select full width */
    .credit-box input,
    .credit-box select {
        width: 100% !important;
        padding: 8px;
        font-size: 14px;
        border-radius: 6px;
    }

    /*ADD CREDIT BUTTON  */
    .credit-box button,
    .btn-add {
        width: 90%;
        max-width: 320px;
        display: block;
        margin: 15px auto 0;
        padding: 10px 0;
        font-size: 15px;
        border-radius: 10px;
        text-align: center;
    }

    /*  TRANSACTIONS TABLE SCROLL */
    .ledger-table-scroll {
        width: 100%;
        overflow-x: auto;                  
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x;
        margin-bottom: 20px;
    }

    .ledger-table {
        min-width: 550px;     
        width: max-content;
        table-layout: fixed;
        font-size: 11px;
        background: white;
        border: 1px solid #ccc !important;
          
        
        
    }

    .ledger-table:last-of-type {
           /*  table itself inside */
        margin: 6px auto;
        table-layout: auto;        
        font-size: 11px;
    }

    .ledger-table:last-of-type th,
    .ledger-table:last-of-type td {
        padding: 4px 4px;
        text-align: center;
        white-space: normal;
        word-break: break-word;
    }

    

    /* Date column slightly narrow */
    .ledger-table:last-of-type th:nth-child(1),
    .ledger-table:last-of-type td:nth-child(1) {
        width: 85px;
    }

    /* Amount / Balance */
    .ledger-table:last-of-type th:nth-child(2),
    .ledger-table:last-of-type td:nth-child(2),
    .ledger-table:last-of-type th:nth-child(4),
    .ledger-table:last-of-type td:nth-child(4) {
        width: 65px;
        border: 1px solid #ccc !important;
    }

    .ledger-table:last-of-type th:nth-child(3),
    .ledger-table:last-of-type td:nth-child(3) {
        width: 55px;          
        max-width: 55px;
        padding: 3px 2px;
        font-size: 10px;
        white-space: nowrap;  
        text-align: center;
    }

    .ledger-table:last-of-type tr {
        height: auto;
    }

    .ledger-table:last-of-type th:last-child,
    .ledger-table:last-of-type td:last-child {
        width: 60px;
        min-width: 60px;
        max-width: 60px;
        padding: 2px;
        vertical-align: middle;
        text-align: center;
        
        

    }

    /* Action column */
    .ledger-table:last-of-type td.action-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;   
        gap: 4px;
        height: 100%; 
                    
    }

     .ledger-table:last-of-type .btn-action {
       
        font-size: 10px;
        padding: 3px 0;
        margin: 0;
        line-height: 1.2;
        border-radius: 5px;
       
    }


    .ledger-table th,
    .ledger-table td {
        padding: 6px 4px;
        text-align: center;
        white-space: normal;
        word-break: break-word;
    }

    /* ACTION BUTTONS */
    .action-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        
    }

    .btn-action {
        
        font-size: 10px;
        padding: 4px 0;
        border-radius: 6px;
        text-align: center;
    }

    @media (max-width: 768px) {

    /*  ONLY Customer Transactions table */
    h3 + .ledger-table {
        width: calc(100% - 10px);   
        margin: 0 auto;
        table-layout: fixed;        
        min-width: unset;           
    }

    /*  Actions column width control */
    h3 + .ledger-table th:nth-last-child(1),
    h3 + .ledger-table td:nth-last-child(1),
    h3 + .ledger-table th:nth-last-child(2),
    h3 + .ledger-table td:nth-last-child(2) {
        width: 55px;
        max-width: 55px;
        padding: 2px;
        text-align: center;
    }

    /*  Buttons fit inside */
    h3 + .ledger-table .btn-action {
        width: 48px;
        font-size: 10px;
        padding: 3px 0;
        margin: 0;
        line-height: 1.2;
    }

    

    
}
}
@media (max-width: 768px) {

    /*  Remove action cell box */
    .ledger-table td.action-col {
        border: none !important;        
        background: transparent !important;
        padding: 6px 0 !important;
       
        display: flex !important;
        flex-direction: column;
        align-items: center !important;     
        justify-content: center !important; 
        text-align: center !important;
        
    
    }

    /*  Remove inner table cell border (safety) */
    .ledger-table td:last-child,
    .ledger-table td:nth-last-child(2) {
        border: none !important;
        background: transparent !important;
        text-align: center !important;  
        vertical-align: middle;
    }

    /*  Buttons clean look */
    .ledger-table td.action-col .btn-action {
        border: none;
        box-shadow: none;
        outline: none;
        margin: 4px auto !important;       
        
        display: inline-block;
    }
}
@media (max-width: 768px) {

    .ledger-table th:last-child,
    .ledger-table td:last-child {
        text-align: center;
        vertical-align: middle;
    }

    .ledger-table td.action-col {
        display: flex;
        flex-direction: column;
        align-items: center;     
        justify-content: center; 
        gap: 6px;
        border: none;
        background: transparent;
    }

    .ledger-table td.action-col .btn-action {
        width: 50px;
        margin: 0 auto;
        font-size: 11px;
        padding: 5px 0;
    }
}







    

</style>




<div class="ledger-header">
    <h2>{{ customer.name }}</h2>
    {% if customer_date %}
    <p><strong>Date:</strong> {{ customer_date|date:"d-m-Y" }}</p>
    {% endif %}
    <p><b>Phone:</b> {{ customer.phone }}</p>
    <p><b>Address:</b> {{ customer.address }}</p>
</div>
<div style="margin-left:20px; margin-bottom:20px;">

    {% if mode == "view" %}
        <a href="{% url 'accounts:export_customer_pdf' customer.id %}"
           class="btn-download">
            ðŸ“„ Download Invoice
        </a>
    {% endif %}

</div>
<hr>


<h2 style="margin-left:20px;">Totals</h2>

<table class="totals-box">
    <tr>
        <th>Total Selling</th>
        <td>â‚¹{{ total_selling }}</td>
    </tr>
    <tr>
        <th>Total Advance</th>
        <td>â‚¹{{ total_advance }}</td>
    </tr>
    <tr>
        <th>Total Credit Received</th>
        <td>â‚¹{{ total_credit }}</td>
    </tr>
    <tr>
        <th>Balance</th>
        <td>â‚¹{{ balance }}</td>
    </tr>
</table>




<div style="margin-left:20px; margin-bottom:20px;">
    <a href="{% url 'accounts:add_transaction' customer.id %}" class="btn-add">+ Add Product</a>
</div>




<h3>Product Details</h3>

<div class="ledger-table-scroll">

    <table class="ledger-table">
        <tr>
            <th>Date</th>
            <th>Product</th>
            <th>Brand Name</th>
            <th>Quantity</th>
            <th>Selling Price</th>
            
            <th>Advance</th>
            <th>Balance</th>
            <th>Method</th>
            <th colspan="2">Actions</th>
        </tr>

        {% for t in transactions %}
        <tr>
            <td>{{ t.date|date:"M d, Y" }}</td>
            <td>{{ t.product_name }}</td>
            <td>
                {% if t.brand %}
                    {{ t.brand.name }}
                {% else %}
                    â€”
                {% endif %}
            </td>
            <td>{{ t.quantity }}</td> 
            <td>â‚¹{{ t.selling_price }}</td>
            
            <td class="box-green">â‚¹{{ t.advance_amount }}</td>
            <td class="box-red">â‚¹{{ t.balance }}</td>
            <td>{{ t.payment_method }}</td>

            <td class="action-col">
                <a href="{% url 'accounts:transaction_edit' t.id %}" class="btn-action btn-edit">Edit</a>
                
            </td>
            <td class="action-col">
                <a href="{% url 'accounts:transaction_delete' t.id %}" class="btn-action btn-delete">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>



<h2>Customer Crediting</h2>

<form method="POST" action="{% url 'accounts:customer_ledger' customer.id %}">
    {% csrf_token %}

    <div class="credit-box">
        <table style="width:100%; border-collapse: separate; border-spacing: 0 12px; font-size:17px;">
            <tr>
                <td><b>Payment Method:</b></td>
                <td>{{ credit_form.payment_method }}</td>
            </tr>

            <tr>
                <td><b>Amount:</b></td>
                <td>{{ credit_form.amount }}</td>
            </tr>

            <tr>
                <td><b>Date:</b></td>
                <td>{{ credit_form.date }}</td>
            </tr>
        </table>

        <div style="text-align: center; margin-top: 20px;">
            <button type="submit" class="btn-add">Add Credit</button>
        </div>
    </div>
</form>




<h3>Customer Transactions</h3>

<table class="ledger-table">
    <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Balance</th>
        <th>Actions</th>
    </tr>

    {% for c in credits %}
    <tr>
        <td>{{ c.date|date:"M d, Y, h:i a" }}</td>
        <td class="box-green">â‚¹{{ c.amount }}</td>
        <td>{{ c.payment_method }}</td>
        <td class="box-red">â‚¹{{ c.balance }}</td>

        <td class="action-col">
            <a href="{% url 'accounts:credit_edit' c.id %}" class="btn-action btn-edit">Edit</a>
            <a href="{% url 'accounts:credit_delete' c.id %}" class="btn-action btn-delete">Delete</a>
        </td>

        
    </tr>
    {% endfor %}
</table>

<script>
    
    window.addEventListener("pageshow", function(event) {
        if (event.persisted) {
            window.location.reload();
        }
    });
</script>


{% endblock %}
