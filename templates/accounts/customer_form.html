{% extends "accounts/base.html" %}

{% block content %}

<h2 class="page-title">Add New Customer & First Transaction</h2>


<div class="instruction-box">
    ⚠️ <strong>Instruction:</strong><br>
    First add at least one product before creating a customer transaction.
    <br>
    <a href="{% url 'accounts:add_product' %}">➕ Add Product</a>
</div>



<div class="form-card">

    <form method="POST">
        {% csrf_token %}

        
        <h3 class="section-title">Customer Details</h3>

        <label>Name:</label>
        {{ customer_form.name }}

        <label>Phone:</label>
        {{ customer_form.phone }}

        <label>Address:</label>
        {{ customer_form.address }}

        <div class="form-row">
            <label>Customer Mode:</label>

            <select name="customer_mode" id="id_customer_mode">
                <option value="">---------</option>
                {% for value, label in customer_form.fields.customer_mode.choices %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>

        </div>

        <br>



        <hr>

        
        <h3 class="section-title">First Transaction Details</h3>

        <label>Product Name:</label>
        {{ transaction_form.product }}

        <label>Brand Name:</label>
        {{ transaction_form.brand }}

        <p id="stock-warning" class="stock-warning">
            ❌ Out of stock
        </p>

        <label>Quantity:</label>
        {{ transaction_form.quantity }}

        <label>Selling Price:</label>
        {{ transaction_form.selling_price }}
        <input type="hidden" id="original_price" value="0">


        

        <label>Advance Amount:</label>
        {{ transaction_form.advance_amount }}

        <label>Date:</label>
        {{ transaction_form.date }}

        <label>Payment Method:</label>
        {{ transaction_form.payment_method }}

        <div class="center-btn">
            <button type="submit"
                    id="save-btn"
                    class="primary-btn"
                    {% if no_products %}disabled{% endif %}>
                Save Customer
            </button>
        </div>

    </form>
</div>




<style>


.primary-btn:disabled {
    background-color: #9bbcf5;   
    color: #ffffff;
    cursor: not-allowed;        
    opacity: 0.65;
}


.primary-btn:disabled:hover {
    background-color: #9bbcf5;
}

.stock-warning {
    margin-top: 6px;
    margin-left: 2px;
    font-size: 14px;
    font-weight: 500;
    color: #dc3545;
    font-family: "Segoe UI", sans-serif;
    display: none;
}


.instruction-box {
    max-width: 700px;         
    margin: 20px auto;         
    background: #e7f3ff;
    border-left: 5px solid #0d6efd;
    padding: 16px 20px;
    border-radius: 10px;
    font-size: 16px;
    color: #084298;
    text-align: center;        
}

.instruction-box a {
    display: inline-block;
    margin-top: 6px;
    font-weight: bold;
    color: #0d6efd;
    text-decoration: none;
}

.textarea {
    height: 44px !important;   
    resize: none;              
    overflow: hidden;          
}

.form-card {
    width: 45%;
    margin: auto;
    background: #ffffff;
    padding: 35px;
    border-radius: 16px;
    border: 1px solid #ddd;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.page-title, .section-title {
    text-align: center;
    font-weight: 700;
}

label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
    font-size: 16px;
}

input, select, textarea {
    width: 95%;
    display: block;
    margin: auto;
    margin-top: 6px;
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

textarea {
    height: 90px;
    resize: vertical;
}

.center-btn {
    text-align: center;
    margin-top: 20px;
}

.primary-btn {
    background: #007bff;
    color: white;
    padding: 12px 30px;
    border-radius: 8px;
    border: none;
    font-size: 18px;
    cursor: pointer;
}

.primary-btn:hover {
    background: #0056b3;
}

/* Calculator Styling */
#miniCalc {
    position: fixed;
    top: 160px;
    right: 120px;
    width: 240px;
    padding: 15px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.20);
    font-family: Arial;
    z-index: 9999;
}

#calcDisplay {
    width: 100%;
    height: 45px;
    font-size: 20px;
    text-align: right;
    padding: 10px;
    border: 1px solid #bbb;
    border-radius: 8px;
    margin-bottom: 12px;
    box-sizing: border-box;
}

.calc-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
}

.calc-buttons button {
    height: 48px;
    font-size: 18px;
    border: none;
    background: #f3f3f3;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
}

.calc-buttons button:hover { background: #e4e4e4; }
.calc-buttons .op { background: #ffe0b3; }
.calc-buttons .eq { background: #80c7ff; }
.calc-buttons .clear {
    grid-column: span 4;
    height: 50px;
    background: #ff8b8b;
    font-size: 20px;
    margin-top: 5px;
}

@media (max-width: 768px) {

    /*  Prevent horizontal scroll  */
    html, body {
        width: 100%;
        overflow-x: hidden;
    }

    /*  Page title  */
    .page-title {
        font-size: 20px;
        margin: 16px 12px;
        text-align: center;
    }

    /*  Instruction box  */
    .instruction-box {
        width: calc(100% - 24px);
        margin: 12px auto 18px;
        padding: 14px 16px;
        font-size: 14px;
        border-radius: 12px;
        text-align: center;
    }

    /* MAIN FORM CARD */
    .form-card {
        width: calc(100% - 24px);   
        max-width: 420px;
        margin: 0 auto 20px;
        padding: 20px 16px;

        border-radius: 16px;
        box-shadow: none;
        border: 1px solid #e0e0e0;
        background: #fff;

        box-sizing: border-box;
    }

    /*  Section titles */
    .section-title {
        font-size: 18px;
        margin: 18px 0 12px;
        text-align: center;
    }

    /* Labels  */
    label {
        display: block;
        width: 100%;
        text-align: left;
        font-size: 15px;
        font-weight: 600;
        margin-top: 14px;
        margin-bottom: 6px;
    }

    /*  Inputs / selects */
    input,
    select,
    textarea {
        width: 100% !important;
        margin: 0;
        padding: 11px 12px;
        font-size: 15px;
        font-weight: 500;

        border-radius: 8px;
        box-sizing: border-box;
    }

    /*  Profit % input */
    #profit_percentage {
        text-align: center;
        font-weight: bold;
    }

    /* Stock warning  */
    .stock-warning {
        margin-top: 6px;
        font-size: 14px;
        text-align: left;
    }

    /*Save button  */
    .center-btn {
        margin-top: 22px;
        text-align: center;
    }

    .primary-btn {
        width: 100%;
        padding: 14px 0;
        font-size: 16px;
        border-radius: 10px;
    }
}








</style>


<script>
document.addEventListener("DOMContentLoaded", function () {

    const productSelect = document.getElementById("id_product");
    const quantityInput = document.getElementById("id_quantity");
    const sellingInput  = document.getElementById("id_selling_price");
    const warning       = document.getElementById("stock-warning");
    const saveBtn       = document.getElementById("save-btn");
    const originalPriceInput = document.getElementById("original_price");

    const productStock = JSON.parse('{{ product_stock_json|escapejs }}');

    async function updateSellingPriceAndStock() {

        const productId = productSelect.value;
        const qty = parseInt(quantityInput.value) || 1;

        sellingInput.value = 0;
        warning.style.display = "none";

        if (!productId) return;

        const stock = productStock[productId];

        if (stock === 0) {
            warning.innerText = "❌ Out of stock";
            warning.style.display = "block";
            saveBtn.disabled = true;
            return;
        }

        if (qty > stock) {
            warning.innerText = `⚠️ Only ${stock} stock available`;
            warning.style.display = "block";
            saveBtn.disabled = true;
            return;
        }

        saveBtn.disabled = false;

        // ✅ SAFE URL
        const url = "{% url 'accounts:get_product_price' 0 %}".replace("0", productId);
        const response = await fetch(url);
        const data = await response.json();

        const customerPrice = data.customer_price || 0;
        const originalPrice = data.price || 0;

        originalPriceInput.value = originalPrice;
        sellingInput.value = customerPrice * qty;
    }

    productSelect.addEventListener("change", updateSellingPriceAndStock);
    quantityInput.addEventListener("input", updateSellingPriceAndStock);
});
</script>


















{% endblock %}
